<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Exerc√≠cio 1: Desenho</title>
  <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js  "></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: 'Segoe UI', Arial, sans-serif;
      overflow: hidden;
    }

    #splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #f0f4ff;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      flex-direction: column;
      text-align: center;
      color: #333;
    }

    #splash-screen h1 {
      font-size: 3.5rem;
      font-weight: bold;
      color: #2c55d9;
      text-shadow: 2px 2px 8px rgba(0,0,0,0.1);
      margin: 0;
      animation: fadeIn 0.5s ease-in;
    }

    #splash-screen p {
      font-size: 1.5rem;
      color: #555;
      margin-top: 20px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    #character-target-div {
      display: none;
      margin: 40px auto;
      width: 300px;
      height: 300px;
    }

    /* === Overlay piscando === */
    #feedback-overlay {
      pointer-events: none;
      position: fixed;
      inset: 0;
      opacity: 0;
      transition: opacity 0s;
      z-index: 9999;
    }

    @keyframes flash {
      0% { opacity: 0; }
      50% { opacity: 0.7; }
      100% { opacity: 0; }
    }

    #feedback-overlay.success {
      background: green;
    }

    #feedback-overlay.error {
      background: red;
    }

    #feedback-overlay.animate {
      opacity: 0.7;
      animation: flash 0.8s ease-out;
    }
  </style>
</head>
<body>

<!-- Tela de abertura -->
<div id="splash-screen">
  <h1>Desenhe aqui</h1>
  <p>qualquer caractere chin√™s do dicion√°rio da li√ß√£o!</p>
</div>

<!-- Container para HanziWriter -->
<div id="character-target-div"></div>

<!-- Overlay para piscar -->
<div id="feedback-overlay"></div>

<script>
  // ‚úÖ Fun√ß√£o universal para enviar resultado e pontos
  function sendResult(success, message, points = 0) {
    window.parent.postMessage({
      type: "TASK_RESULT",
      success: !!success,
      message: message || (success ? "Exerc√≠cio conclu√≠do" : "Erro"),
      points: points // ‚úÖ Envia os pontos
    }, "*");
  }

  // ‚úÖ Fun√ß√£o para piscar a tela
  function flashScreen(color) {
    const overlay = document.getElementById('feedback-overlay');
    overlay.className = '';
    overlay.classList.add(color === 'success' ? 'success' : 'error');
    overlay.classList.add('animate');

    setTimeout(() => {
      overlay.classList.remove('animate');
    }, 800);
  }

  let totalPointsEarned = 0;
  let strokeCount = 0;
  let mistakes = 0;

  window.onload = function() {
    const splashScreen = document.getElementById('splash-screen');
    const characterDiv = document.getElementById('character-target-div');
    const splashH1 = splashScreen.querySelector('h1');
    const splashP = splashScreen.querySelector('p');

    setTimeout(() => {
      const hash = window.location.hash.slice(1);
      if (!hash) {
        splashP.textContent = "‚ö†Ô∏è Caractere chin√™s n√£o especificado";
        sendResult(false, "Caractere chin√™s n√£o especificado", 0);
        return;
      }

      const char = decodeURIComponent(hash);

      // Mostra o caractere chin√™s
      splashH1.textContent = char;

      // === Tenta carregar os dados do caractere chin√™s ===
      HanziWriter.loadCharacterData(char)
        .then(charData => {
          // ‚úÖ Dados existem ‚Äî inicia o quiz
          splashScreen.style.display = 'none';
          characterDiv.style.display = 'block';

          // Conta o n√∫mero de tra√ßos
          strokeCount = charData.strokes.length;

          const writer = HanziWriter.create('character-target-div', char, {
            width: 300,
            height: 300,
            showCharacter: false,
            showOutline: false,
            showHintAfterMisses: 1,
            highlightOnComplete: false,
            padding: 5
          });

          writer.quiz({
            leniency: 2.0,

            onCorrectStroke: function(strokeData) {
              // ‚úÖ +1 ponto por tra√ßo correto
              totalPointsEarned += 1;
              console.log(`‚úÖ Tra√ßo ${strokeData.strokeNum} ‚Äî +1 ponto`);
            },

            onMistake: function(strokeData) {
              console.log("‚ùå Erro no tra√ßo", strokeData.strokeNum);
              flashScreen('error');
              mistakes++;
            },

            onComplete: function(summaryData) {
              console.log("üéØ Quiz conclu√≠do:", summaryData);
              flashScreen('success');

              // ‚úÖ +2 pontos por conclus√£o completa
              totalPointsEarned += 2;

              sendResult(
                true,
                `Caractere chin√™s "${char}" desenhado corretamente`,
                totalPointsEarned
              );
            }
          });

        })
        .catch(err => {
          // ‚ùå N√£o h√° dados ‚Äî caractere chin√™s antigo
          console.warn(`üö´ N√£o h√° dados para o caractere chin√™s: ${char}`, err);

          // === MANT√âM A TELA DE ABERTURA, ALTERA O TEXTO ===
          splashP.innerHTML = `
            Caractere chin√™s muito antigo e raro üòî<br>
            O software n√£o suporta sua renderiza√ß√£o.<br>
            <strong>Voc√™ ter√° que escrev√™-lo √† m√£o ‚úçÔ∏è</strong>
          `;

          // Piscar ‚Äî erro
          flashScreen('error');

          // ‚úÖ Nada √© penalizado nem recompensado
          setTimeout(() => {
            sendResult(
              true,
              `Caractere chin√™s antigo "${char}" ‚Äî exerc√≠cio ignorado (sem dados)`,
              0 // üü¢ 0 pontos ‚Äî n√£o √© culpa do usu√°rio
            );
          }, 1200);
        });
    }, 1000);
  };

  // Tratamento para ignorar (por exemplo, se o usu√°rio fechar a janela sem concluir)
  window.addEventListener('beforeunload', () => {
    if (totalPointsEarned === 0 && mistakes > 0) {
      // ‚ùå Ignorado com erros ‚Äî penalidade -1
      sendResult(false, "Exerc√≠cio ignorado", -1);
    }
  });
</script>

<!-- Sinais para a janela pai -->
<script>
  window.parent.postMessage({ type: "TASK_EXISTS", valid: true }, "*");
  window.parent.postMessage({ type: "DO_HANZI", valid: true }, "*");
</script>

</body>
</html>