<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Hier√≥glifos</title>
  <style>
    html, body {
      width: 100%;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      color: #333;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 10px;
      gap: 8px;
      width: 100%;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 16px;
      color: #555;
      flex-shrink: 0;
    }

    .scale-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .scale-btn {
      width: 28px;
      height: 28px;
      font-size: 18px;
      line-height: 28px;
      text-align: center;
      background-color: #e0e0e0;
      border-radius: 50%;
      cursor: pointer;
      user-select: none;
    }

    .scale-value {
      min-width: 36px;
      text-align: center;
      font-weight: bold;
    }

    #progress-container {
      width: 100%;
      height: 6px;
      background-color: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      flex-shrink: 0;
    }

    #progress-bar {
      height: 100%;
      width: 0%;
      background-color: #4caf50;
      transition: width 0.4s ease;
      border-radius: 3px;
    }

    #task-container {
      flex: 1;
      width: 100%;
      border: none;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
      min-height: 0;
      max-height: calc(100vh - 150px);
    }

    #task-container.active {
      opacity: 1;
      visibility: visible;
    }

    #task-frame {
      width: 100%;
      height: 100%;
      border: none;
      transform-origin: center top;
      transform: scale(1);
      transition: transform 0.2s ease;
      overflow: auto;
    }

    .controls {
      padding: 12px 0;
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-shrink: 0;
    }

    button {
      padding: 14px 24px;
      font-size: 18px;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease;
      width: calc(50% - 6px);
      max-width: 200px;
    }

    button:active {
      transform: scale(0.98);
    }

    #next-btn {
      color: white;
      background-color: #1976d2;
    }

    #next-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    #skip-btn {
      color: white;
      background-color: #6c757d;
    }

    #status {
      font-size: 16px;
      text-align: center;
      color: #555;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 0 8px;
    }

    @media (max-width: 768px) {
      #task-container {
        max-height: calc(100vh - 180px);
      }
      
      .controls {
        padding: 8px 0;
      }
      
      button {
        padding: 12px 16px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div id="status">üî§ Pronto para a li√ß√£o</div>
    <div class="scale-controls">
      <div class="scale-btn" id="zoom-out">‚àí</div>
      <div class="scale-value" id="scale-value">1.0</div>
      <div class="scale-btn" id="zoom-in">+</div>
    </div>
  </div>

  <div id="progress-container">
    <div id="progress-bar"></div>
  </div>

  <div id="task-container">
    <iframe id="task-frame" src="about:blank" frameborder="0" allowfullscreen></iframe>
  </div>

  <div class="controls">
    <button id="next-btn">‚ñ∂Ô∏è Iniciar!</button>
    <button id="skip-btn" style="display: none;">‚è≠Ô∏è Pular</button>
  </div>

  <script src="./../dictionary.js"></script>

<script>
  // === CONFIGURA√á√ÉO DA LI√á√ÉO ===
  const LESSON =  parseInt((window.location.pathname.match(/\/lesson(\d+)(?:\/|$)/) || [])[1] || '1');

  if (typeof charData === 'undefined') {
    console.error('‚ùå dictionary.js n√£o carregado');
    alert('Erro: n√£o foi poss√≠vel carregar o dicion√°rio de hier√≥glifos.');
    throw new Error('charData not found');
  }

  const lessonwords = Object.keys(charData).filter(key => {
    const data = charData[key];
    return data.lesson === LESSON && key.length === 1; // apenas hier√≥glifos √∫nicos
  });

  if (lessonwords.length === 0) {
    console.error(`‚ùå Nenhum hier√≥glifo encontrado para a li√ß√£o ${LESSON}`);
    alert(`Nenhum hier√≥glifo encontrado para a li√ß√£o ${LESSON}`);
  }

  function shuffleArray(array) {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  const shuffledLesson = shuffleArray(lessonwords);
  const totalTasks = shuffledLesson.length;
  let currentTaskIndex = 0;

  let currentScale = 1.0;
  const minScale = 0.25;
  const maxScale = 2.0;
  const scaleStep = 0.1;

  const iframe = document.getElementById("task-frame");
  const statusEl = document.getElementById("status");
  const nextBtn = document.getElementById("next-btn");
  const skipBtn = document.getElementById("skip-btn");
  const progressBar = document.getElementById("progress-bar");
  const scaleValueEl = document.getElementById("scale-value");
  const zoomInBtn = document.getElementById("zoom-in");
  const zoomOutBtn = document.getElementById("zoom-out");

  function setScale(scale) {
    currentScale = Math.max(minScale, Math.min(maxScale, Math.round(scale * 10) / 10));
    iframe.style.transform = `scale(${currentScale})`;
    scaleValueEl.textContent = currentScale.toFixed(1);
  }

  zoomInBtn.addEventListener("click", () => setScale(currentScale + scaleStep));
  zoomOutBtn.addEventListener("click", () => setScale(currentScale - scaleStep));

  function playHanziSound(hanzi) {
    const data = charData[hanzi];
    if (!data || !data.pinyin) return;

    let cleanPinyin = data.pinyin
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/√º/g, 'u')
      .replace(/v/g, 'u');

    let tone = '1';
    if (data.pinyin.includes('ƒÅ')) tone = '1';
    else if (data.pinyin.includes('√°')) tone = '2';
    else if (data.pinyin.includes('«é')) tone = '3';
    else if (data.pinyin.includes('√†')) tone = '4';

    const pinyinKey = cleanPinyin + tone;
    const url = `https://data.dong-chinese.com/pinyin/b/  ${pinyinKey}.mp3`;
    const audio = new Audio(url);

    audio.play().catch(e => {
      console.warn(`üîá Sem som para ${hanzi}`);
    });
  }


// --- üî• Inicializa√ß√£o corrigida do Firebase ---
let db = null;
let auth = null;
let currentUser = null;
let updateDocRef = null;
let docRef = null;

async function initFirebase() {
  try {
    const [{ initializeApp }, { getAuth, onAuthStateChanged }, { getFirestore }, { updateDoc, doc }] = await Promise.all([
      import('https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js  '),
      import('https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js  '),
      import('https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js  '),
      import('https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js  ')
    ]);

    const firebaseConfig = {
      apiKey: "AIzaSyBvyxPtx5PICYk60HUCERw5Cxh1TyCcZCY",
      authDomain: "antient-9bff0.firebaseapp.com",
      projectId: "antient-9bff0",
      storageBucket: "antient-9bff0.firebasestorage.app",
      messagingSenderId: "311792589414",
      appId: "1:311792589414:web:5fff3154735007c2006ba7",
      measurementId: "G-W4ZQXWRTKK"
    };

    const app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
    updateDocRef = updateDoc;
    docRef = doc;

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      console.log('üîê Usu√°rio:', user ? user.displayName : 'n√£o autenticado');
    });
  } catch (e) {
    console.error("‚ùå Erro ao inicializar o Firebase:", e);
  }
}

// Inicia o Firebase
initFirebase();

// --- üî• Tratamento de pontos ---
window.addEventListener("message", async function(event) {
  if (event.data.type === "TASK_RESULT") {
    const { success, message, points = 0 } = event.data;

    console.log(`[Pontos] Recebido: ${points} | Mensagem: ${message}`);

    if (success && points !== 0 && db && currentUser && updateDocRef && docRef) {
      try {
        const userRef = docRef(db, 'users', currentUser.uid);
        await updateDocRef(userRef, {
          points: (currentUser.points || 0) + points
        });
        // Atualiza localmente
        if (currentUser.points === undefined) currentUser.points = 0;
        currentUser.points += points;
        console.log(`[Pontos] Salvo. Agora: ${currentUser.points}`);
      } catch (e) {
        console.error("‚ùå Falha ao salvar pontos no Firestore:", e);
      }
    }

    if (success) {
      statusEl.textContent = "‚úÖ Conclu√≠do! Pode continuar";
      nextBtn.disabled = false;
    }
  }
});

  function loadNextTask() {
    if (currentTaskIndex >= totalTasks) return;

    const hanzi = shuffledLesson[currentTaskIndex];
    const data = charData[hanzi] || {};

    const url = `tasks/task1.html?_=${Date.now()}#${encodeURIComponent(hanzi)}`;

    const meaningDisplay = (data.meaning?.length > 50)
      ? data.meaning.slice(0, 47) + '...'
      : data.meaning || 'significado n√£o encontrado';

    statusEl.textContent = `${hanzi} ‚Ä¢ ${data.pinyin || '‚Äî'} ‚Ä¢ ${meaningDisplay}`;
    statusEl.title = `${data.meaning || ''}`;

    document.getElementById("task-container").classList.add("active");
    nextBtn.disabled = true;
    if (skipBtn) skipBtn.style.display = "block";

    iframe.src = '';
    setTimeout(() => { iframe.src = url; }, 50);

    setTimeout(() => playHanziSound(hanzi), 600);
    progressBar.style.width = `${(currentTaskIndex / totalTasks) * 100}%`;
  }

  nextBtn.addEventListener("click", () => {
    if (currentTaskIndex === 0) {
      nextBtn.textContent = "‚ñ∂Ô∏è Pr√≥ximo";
      loadNextTask();
      currentTaskIndex++;
      return;
    }

    if (currentTaskIndex < totalTasks) {
      loadNextTask();
      currentTaskIndex++;
      return;
    }

    iframe.style.display = "none";
    nextBtn.disabled = true;
    skipBtn.style.display = "none";
    statusEl.innerHTML = `<div style="text-align: center;">
      <h2>üéâ Parab√©ns!</h2>
      <p>Voc√™ concluiu a li√ß√£o ${LESSON}</p>
    </div>`;
    setTimeout(() => window.location.href = "../", 3000);
  });

if (skipBtn) {
  skipBtn.addEventListener("click", async () => {
    // ‚ùå Pular ‚Äî penalidade -1
    if (db && currentUser && updateDocRef && docRef) {
      try {
        const userRef = docRef(db, 'users', currentUser.uid);
        await updateDocRef(userRef, {
          points: (currentUser.points || 0) - 1
        });
        if (currentUser.points === undefined) currentUser.points = 0;
        currentUser.points -= 1;
        console.log("[Pontos] Pular: -1");
      } catch (e) {
        console.error("‚ùå Falha ao aplicar penalidade:", e);
      }
    }

    loadNextTask();
    currentTaskIndex++;
    if (currentTaskIndex >= totalTasks) {
      nextBtn.click();
    }
  });
}

  window.addEventListener("load", () => {
    console.log(`üìö Li√ß√£o ${LESSON}: ${lessonwords.length} hier√≥glifos`);
    console.log("üé≤ Ordem:", shuffledLesson);
    setScale(1.0);
  });
</script></body>
</html>