<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz de Caracteres Chineses</title>
    <script src="../dictionary.js"></script>
    <link rel="stylesheet" type="text/css" href="../vocab.css">
</head>
<body>
    <div class="container">
        <h1>Associe os Caracteres</h1>
        
        <div class="controls">
            <div id="status" class="status">Associe os caracteres</div>
        </div>
        
        <div class="matching-container">
            <div class="column" id="leftColumn"></div>
            <div class="column" id="rightColumn"></div>
        </div>
        
        <div class="progress">
            <div id="progressBar" class="progress-bar"></div>
        </div>
        
        <button id="nextBtn" class="btn">Pr√≥xima tarefa</button>
        
        <div class="feedback correct-feedback" id="correctFeedback">‚úì Correto! +1 ponto</div>
        <div class="feedback incorrect-feedback" id="incorrectFeedback">‚úó Incorreto -1 ponto</div>
    </div>

    <script>
        // === CONFIGURA√á√ÉO DA AULA ===
        const LESSON =  parseInt((window.location.pathname.match(/\/lesson(\d+)(?:\/|$)/) || [])[1] || '1');
        
        // === SISTEMA DE SONS DA INTERFACE ===
        const uiSounds = {
            click: null,
            hover: null,
            success: null,
            error: null,
            next: null,
            complete: null
        };

        // Fun√ß√£o para pr√©-carregar um som
        function preloadSound(path) {
            return new Promise((resolve, reject) => {
                const audio = new Audio();
                audio.src = path;
                audio.preload = 'auto';
                audio.addEventListener('canplaythrough', () => resolve(audio));
                audio.addEventListener('error', reject);
            });
        }

        // Fun√ß√£o para pr√©-carregar todos os sons da interface
        async function preloadUISounds() {
            try {
                // Caminho relativo para a pasta Wav
                const basePath = '../Wav/';

                // Pr√©-carrega os sons
                uiSounds.click = await preloadSound(basePath + 'Click_Standard_00.wav');
                uiSounds.hover = await preloadSound(basePath + 'Click_Soft_00.wav');
                uiSounds.success = await preloadSound(basePath + 'Click_Electronic/Click_Electronic_05.wav');
                uiSounds.error = await preloadSound(basePath + 'Click_Heavy_00.wav');
                uiSounds.next = await preloadSound(basePath + 'Slide_Sharp_00.wav');
                uiSounds.complete = await preloadSound(basePath + 'Click_Mechanical_01.wav');

                console.log('Todos os sons da interface carregados com sucesso');
            } catch (error) {
                console.warn('Falha ao carregar alguns sons da interface:', error);
            }
        }

        // Fun√ß√£o para reproduzir som
        function playSound(sound, volume = 0.3) {
            if (sound) {
                // Cria um clone para permitir m√∫ltiplas reprodu√ß√µes
                const soundClone = sound.cloneNode();
                soundClone.volume = volume;
                soundClone.play().catch(e => {
                    console.warn('Falha ao reproduzir som:', e);
                });
            }
        }

        // === INICIALIZA√á√ÉO DO FIREBASE ===
        let db = null;
        let auth = null;
        let currentUser = null;
        let updateDocRef = null;
        let docRef = null;
        let getDocRef = null;

        async function initFirebase() {
            try {
                const [{ initializeApp }, { getAuth, onAuthStateChanged }, { getFirestore }, { updateDoc, doc, getDoc }] = await Promise.all([
                    import('https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js    '),
                    import('https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js    '),
                    import('https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js    '),
                    import('https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js    ')
                ]);

                const firebaseConfig = {
                    apiKey: "AIzaSyBvyxPtx5PICYk60HUCERw5Cxh1TyCcZCY",
                    authDomain: "antient-9bff0.firebaseapp.com",
                    projectId: "antient-9bff0",
                    storageBucket: "antient-9bff0.firebasestorage.app",
                    messagingSenderId: "311792589414",
                    appId: "1:311792589414:web:5fff3154735007c2006ba7",
                    measurementId: "G-W4ZQXWRTKK"
                };

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                updateDocRef = updateDoc;
                docRef = doc;
                getDocRef = getDoc;

                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    console.log('üîê Usu√°rio:', user ? user.displayName : 'n√£o autenticado');
                });
            } catch (e) {
                console.error("‚ùå Erro ao inicializar Firebase:", e);
            }
        }

        // === REPRODU√á√ÉO DE SOM DOS HANZI ===
function playHanziSound(hanzi) {
    const data = charData[hanzi];
    if (!data || !data.pinyin) return;

    let cleanPinyin = data.pinyin
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/√º/g, 'u')
        .replace(/v/g, 'u');

    let tone = '1';
    if (data.pinyin.includes('ƒÅ')) tone = '1';
    else if (data.pinyin.includes('√°')) tone = '2';
    else if (data.pinyin.includes('«é')) tone = '3';
    else if (data.pinyin.includes('√†')) tone = '4';

    const pinyinKey = cleanPinyin + tone;
    const url = `https://data.dong-chinese.com/pinyin/b/  ${pinyinKey}.mp3`;

    // Cria objeto de √°udio
    const audio = new Audio(url);

    // üöÄ Usa o m√©todo play() dentro do manipulador de clique
    // Isso garante que a reprodu√ß√£o seja iniciada pelo usu√°rio
    audio.play().catch(e => {
        console.warn(`üîá Sem som para ${hanzi}`, e.message);
    });
}
        // === SISTEMA DE PONTOS ===
        async function updateUserPoints(pointsChange) {
            if (!db || !currentUser || !updateDocRef || !docRef || !getDocRef) {
                console.warn("Firebase n√£o inicializado, pontos n√£o salvos");
                return;
            }

            try {
                const userRef = docRef(db, 'users', currentUser.uid);
                
                // Obt√©m os pontos atuais do usu√°rio
                const userDoc = await getDocRef(userRef);
                let currentPoints = 0;
                
                if (userDoc.exists()) {
                    currentPoints = userDoc.data().points || 0;
                }
                
                // Atualiza os pontos considerando os atuais
                const newPoints = currentPoints + pointsChange;
                
                await updateDocRef(userRef, {
                    points: newPoints
                });
                
                currentUser.points = newPoints;
                console.log(`[Pontos] Altera√ß√£o: ${pointsChange}. Agora: ${newPoints}`);
            } catch (e) {
                console.error("‚ùå Falha ao salvar pontos no Firestore:", e);
            }
        }

        // === L√ìGICA PRINCIPAL DO QUIZ ===
        let selectedLeft = null;
        let selectedRight = null;
        let matchedPairs = 0;
        let totalPairs = 0;
        let leftItems = [];
        let rightItems = [];
        let allLessonChars = [];
        
        // Rastreamento de progresso por caractere
        let charProgress = {};
        let currentTaskType = ''; // 'pinyin' ou 'meaning'
        let currentChars = [];

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async function() {
            await initFirebase();
            await preloadUISounds(); // Espera o carregamento dos sons
            
            // Obt√©m todos os caracteres da li√ß√£o
            allLessonChars = Object.keys(charData).filter(char => 
                charData[char].lesson === LESSON
            );
            
            totalPairs = allLessonChars.length * 2; // Cada caractere √© verificado duas vezes
            
            // Inicializa o progresso para cada caractere
            allLessonChars.forEach(char => {
                charProgress[char] = {
                    pinyin: false,
                    meaning: false
                };
            });
            
            loadTask();
            
            document.getElementById('nextBtn').addEventListener('click', function() {
                playSound(uiSounds.next); // Som ao avan√ßar para pr√≥xima tarefa
                loadTask();
            });
            
            // Adiciona efeitos hover aos bot√µes
            document.querySelectorAll('.btn').forEach(button => {
                button.addEventListener('mouseenter', () => {
                    playSound(uiSounds.hover); // Som ao passar o mouse sobre o bot√£o
                });
            });
        });
        
        // Carregar tarefa
        function loadTask() {
            selectedLeft = null;
            selectedRight = null;
            matchedPairs = 0;
            
            // Determina tipos de tarefas dispon√≠veis
            const remainingPinyin = allLessonChars.filter(char => !charProgress[char].pinyin);
            const remainingMeaning = allLessonChars.filter(char => !charProgress[char].meaning);
            
            if (remainingPinyin.length === 0 && remainingMeaning.length === 0) {
                // Todos os caracteres foram completamente aprendidos
                playSound(uiSounds.complete); // Som de conclus√£o da li√ß√£o
                document.getElementById('status').textContent = 'Todos os caracteres da li√ß√£o foram totalmente aprendidos!';
                document.getElementById('leftColumn').innerHTML = '';
                document.getElementById('rightColumn').innerHTML = '';
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('nextBtn').disabled = true;
                
                // Redireciona para a p√°gina inicial ap√≥s 2 segundos
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 2000);
                return;
            }
            
            // ESCOLHA ALEAT√ìRIA do tipo de tarefa
            const availableTypes = [];
            if (remainingPinyin.length > 0) availableTypes.push('pinyin');
            if (remainingMeaning.length > 0) availableTypes.push('meaning');
            
            // Escolhe aleatoriamente o tipo entre os dispon√≠veis
            const randomTypeIndex = Math.floor(Math.random() * availableTypes.length);
            currentTaskType = availableTypes[randomTypeIndex];
            
            const remainingChars = currentTaskType === 'pinyin' ? remainingPinyin : remainingMeaning;
            
            // Seleciona at√© 5 caracteres aleat√≥rios (ou menos se houver menos)
            const count = Math.min(5, remainingChars.length);
            currentChars = getRandomCharacters(remainingChars, count);
            
            createColumns(currentChars);
            updateProgress();
            updateStatus();
        }
        
        // Obter caracteres aleat√≥rios
        function getRandomCharacters(charArray, count) {
            const selectedChars = [];
            const tempArray = [...charArray];
            
            for (let i = 0; i < count; i++) {
                const randomIndex = Math.floor(Math.random() * tempArray.length);
                const char = tempArray[randomIndex];
                selectedChars.push({
                    char: char,
                    pinyin: charData[char].pinyin,
                    meaning: charData[char].meaning
                });
                tempArray.splice(randomIndex, 1);
            }
            
            return selectedChars;
        }
        
        // Criar colunas
        function createColumns(chars) {
            const leftColumn = document.getElementById('leftColumn');
            const rightColumn = document.getElementById('rightColumn');
            
            leftColumn.innerHTML = '';
            rightColumn.innerHTML = '';
            
            // Atualiza o texto do status conforme o tipo de tarefa
            const statusText = currentTaskType === 'pinyin' ? 
                'Associe os caracteres √† transcri√ß√£o' : 
                'Associe os caracteres aos significados';
            document.getElementById('status').textContent = statusText;
            
            // Coluna esquerda - caracteres
            leftItems = [];
            chars.forEach(charData => {
                const item = document.createElement('div');
                item.className = 'item';
                item.innerHTML = `<div class="character">${charData.char}</div>`;
                item.dataset.char = charData.char;
                item.dataset.matched = 'false';
                item.addEventListener('click', () => {
                    playSound(uiSounds.click); // Som ao clicar no item
                    selectItem(item, 'left');
                    // Reprodu√ß√£o de som ao clicar no caractere funciona APENAS em tarefas de tradu√ß√£o
                    if (currentTaskType === 'meaning') {
                        playHanziSound(charData.char);
                    }
                });
                // Adiciona efeito hover
                item.addEventListener('mouseenter', () => {
                    playSound(uiSounds.hover); // Som ao passar o mouse sobre o item
                });
                leftColumn.appendChild(item);
                leftItems.push(item);
            });
            
            // Coluna direita - apenas um tipo (pinyin ou meaning)
            rightItems = [];
            const shuffledChars = [...chars].sort(() => Math.random() - 0.5);
            
            shuffledChars.forEach(charData => {
                const item = document.createElement('div');
                item.className = 'item';
                
                if (currentTaskType === 'pinyin') {
                    item.innerHTML = `<div class="pinyin">${charData.pinyin}</div>`;
                    item.dataset.pinyin = charData.pinyin;
                    item.dataset.type = 'pinyin';
                } else {
                    item.innerHTML = `<div class="meaning">${charData.meaning}</div>`;
                    item.dataset.meaning = charData.meaning;
                    item.dataset.type = 'meaning';
                }
                
                item.dataset.char = charData.char;
                item.dataset.matched = 'false';
                item.addEventListener('click', () => {
                    playSound(uiSounds.click); // Som ao clicar no item
                    selectItem(item, 'right');
                });
                // Adiciona efeito hover
                item.addEventListener('mouseenter', () => {
                    playSound(uiSounds.hover); // Som ao passar o mouse sobre o item
                });
                rightColumn.appendChild(item);
                rightItems.push(item);
            });
        }
        
        // Selecionar item
        function selectItem(item, column) {
            if (item.dataset.matched === 'true') return;
            
            if (column === 'left') {
                if (selectedLeft) {
                    selectedLeft.classList.remove('selected');
                }
                selectedLeft = item;
                item.classList.add('selected');
                
                if (selectedRight) {
                    checkMatch();
                }
            } else {
                if (selectedRight) {
                    selectedRight.classList.remove('selected');
                }
                selectedRight = item;
                item.classList.add('selected');
                
                if (selectedLeft) {
                    checkMatch();
                }
            }
        }
        
        // Verificar correspond√™ncia
        function checkMatch() {
            const leftChar = selectedLeft.dataset.char;
            let isMatch = false;
            
            if (currentTaskType === 'pinyin') {
                isMatch = (charData[leftChar].pinyin === selectedRight.dataset.pinyin);
            } else {
                isMatch = (charData[leftChar].meaning === selectedRight.dataset.meaning);
            }
            
            if (isMatch) {
                playSound(uiSounds.success); // Som de sucesso
                showFeedback(true);
                updateUserPoints(1); // +1 ponto por resposta correta
                
                // Reproduz som apenas em tarefas de transcri√ß√£o quando a resposta est√° correta
                if (currentTaskType === 'pinyin') {
                    playHanziSound(leftChar);
                }
                
                selectedLeft.dataset.matched = 'true';
                selectedRight.dataset.matched = 'true';
                selectedLeft.classList.remove('selected');
                selectedLeft.classList.add('matched');
                selectedRight.classList.remove('selected');
                selectedRight.classList.add('matched');
                
                matchedPairs++;
                
                // Se todas as pares foram combinadas nesta tarefa
                if (matchedPairs === leftItems.length) {
                    // Marca os caracteres como conclu√≠dos para este tipo de tarefa
                    leftItems.forEach(item => {
                        charProgress[item.dataset.char][currentTaskType] = true;
                    });
                    
                    // Atualiza o progresso
                    updateProgress();
                    
                    // Libera o bot√£o para pr√≥xima tarefa
                    document.getElementById('nextBtn').disabled = false;
                }
            } else {
                playSound(uiSounds.error); // Som de erro
                showFeedback(false);
                updateUserPoints(-1); // -1 ponto por erro
                
                selectedLeft.classList.remove('selected');
                selectedRight.classList.remove('selected');
            }
            
            selectedLeft = null;
            selectedRight = null;
        }
        
        // Mostrar feedback
        function showFeedback(isCorrect) {
            const feedbackElement = isCorrect ? 
                document.getElementById('correctFeedback') : 
                document.getElementById('incorrectFeedback');
            
            feedbackElement.style.opacity = '1';
            
            setTimeout(() => {
                feedbackElement.style.opacity = '0';
            }, 1500);
        }
        
        // Atualizar progresso da li√ß√£o inteira
        function updateProgress() {
            // Conta o n√∫mero total de verifica√ß√µes conclu√≠das (pinyin + meaning)
            let completedChecks = 0;
            allLessonChars.forEach(char => {
                if (charProgress[char].pinyin) completedChecks++;
                if (charProgress[char].meaning) completedChecks++;
            });
            
            const progress = (completedChecks / totalPairs) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }
        
        // Atualizar status
        function updateStatus() {
            // Bloqueia o bot√£o at√© concluir a tarefa
            document.getElementById('nextBtn').disabled = true;
        }
    </script>
</body>
</html>