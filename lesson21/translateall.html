<!DOCTYPE html>
<html lang="pt">
<head>
    <script src="./../dictionary.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quiz de Tradu√ß√£o de Texto</title>
<style>
    /* === JANELAS MODAIS === */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1001;
        justify-content: center;
        align-items: center;
        padding: 20px;
        backdrop-filter: blur(2px);
    }
    .modal-content {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        width: 90%;
        max-width: 600px;
        overflow: hidden;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #eaeaea;
        background: #f8f6fb;
    }
    .modal-header h3 {
        margin: 0;
        color: #5a5a5a;
        font-size: 16px;
    }
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
        transition: color 0.2s;
    }
    .modal-close:hover {
        color: #555;
    }
    .friends-grid {
        display: grid;
        gap: 8px;
        padding: 16px 20px;
        max-height: 400px;
        overflow-y: auto;
    }
    .friend-card {
        padding: 12px;
        background: #f9f7fc;
        border: 1px solid #d9d4e7;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        color: #5a5a5a;
        transition: all 0.2s ease;
    }
    .friend-card:hover {
        background: #f0eaf9;
        border-color: #d9d4e7;
        transform: translateY(-1px);
    }
    .info-message {
        text-align: center;
        color: #777;
        padding: 20px;
        font-style: italic;
        display: none; /* Ocultar por padr√£o */
    }
    /* === JANELA MODAL DE CHAT === */
    .chat-modal .modal-header {
        background: #fffaf7;
    }
    .chat-modal .modal-content {
        width: 95%;
        max-width: 900px;
    }
    #loadingIframe {
        text-align: center;
        padding: 30px;
        color: #777;
        display: block;
    }
    .chat-iframe {
        width: 100%;
        min-height: 70vh;
        border: none;
        border-top: 1px solid #eee;
        border-radius: 0 0 12px 12px;
        display: none;
    }
    /* Estilos do bot√£o "‚úâÔ∏è" sob .task-type */
    #sendTaskBtn {
        background: #e6f4f1;
        color: #5a9a8f;
        border: 1px solid #c2e3dd;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 11px;
        line-height: 1.2;
        white-space: nowrap;
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        min-width: auto;
        width: auto;
    }
    #sendTaskBtn:hover:not(:disabled) {
        background-color: #c2e3dd;
        color: #3c766f;
        border-color: #a8d8ce;
    }
    #sendTaskBtn:disabled {
        background-color: #c0c0c0;
        border-color: #a0a0a0;
        color: #777;
        cursor: not-allowed;
        opacity: 0.7;
    }
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.5;
        color: #5a5a5a;
        padding: 10px;
        background-color: #fdf6f0;
        font-size: 14px;
    }
    .container {
        max-width: 100%;
        margin: 0 auto;
    }
    .header {
        background-color: #fffaf7;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        margin-bottom: 10px;
        text-align: center;
        border: 1px solid #f5e1da;
    }
    .header h1 {
        color: #7c6b96;
        font-size: 18px;
        margin-bottom: 5px;
    }
    .header p {
        font-size: 12px;
        color: #a0a0a0;
    }
    .progress {
        background-color: #e6f4f1;
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 10px;
        text-align: center;
        font-weight: bold;
        color: #5a9a8f;
        font-size: 13px;
        border: 1px solid #c2e3dd;
    }
    /* Dicion√°rio Colaps√°vel */
    .collapsible-container {
        border: 1px solid #d9d4e7;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .collapsible-header {
        background-color: #f8f6fb;
        padding: 10px;
        cursor: pointer;
        font-weight: bold;
        color: #7c6b96;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
        font-size: 13px;
        border-bottom: 1px solid #eae5f3;
    }
    .collapsible-header::after {
        content: "+";
        font-size: 18px;
        color: #9b9b9b;
    }
    .collapsible-header.active::after {
        content: "‚àí";
    }
    .collapsible-content {
        padding: 0;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        background-color: #fffdfb;
    }
    .collapsible-content.show {
        max-height: 400px;
        padding: 10px;
    }
    .dictionary-content {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 8px;
    }
    .dict-item {
        padding: 6px;
        background-color: #f9f7fc;
        border-radius: 6px;
        border: 1px solid #ece8f3;
        cursor: pointer;
        transition: all 0.2s;
        min-height: 55px;
    }
    .dict-item:hover {
        background-color: #f0eaf9;
        border-color: #d9d4e7;
    }
    .dict-char {
        font-size: 16px;
        font-weight: bold;
        color: #7c6b96;
        margin-bottom: 4px;
    }
    .dict-pinyin {
        font-size: 11px;
        color: #999999;
        margin-bottom: 2px;
    }
    .dict-meaning {
        font-size: 10px;
        color: #777777;
    }
    .task-container {
        background-color: #fffdfb;
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        margin-bottom: 12px;
    }
    .source-text {
        font-size: 16px;
        font-weight: bold;
        text-align: center;
        padding: 10px;
        margin-bottom: 12px;
        background-color: #f8f6fb;
        border-radius: 6px;
        min-height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #eae5f3;
    }
    .task-type {
        display: inline-block;
        background-color: #e6f4f1;
        color: #5a9a8f;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 11px;
        margin-bottom: 8px;
        border: 1px solid #c2e3dd;
        line-height: 1.2;
        white-space: nowrap;
    }
    .words-container, .answer-container {
        border: 1px dashed #d9d4e7;
        border-radius: 6px;
        padding: 10px;
        min-height: 50px;
        margin-bottom: 12px;
        background-color: #f9f7fc;
        font-size: 13px;
    }
    .words-container {
        background-color: #f9f7fc;
    }
    .answer-container {
        background-color: #f0faf8;
        border-color: #a8d8ce;
    }
    .word-list {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }
    .word {
        padding: 6px 10px;
        background-color: #fff;
        border: 1px solid #e0d8e9;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 13px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .word:hover {
        background-color: #f0eaf9;
        transform: translateY(-1px);
        border-color: #d9d4e7;
    }
    .word.selected {
        background-color: #ffb6c1;
        color: #ffffff;
        border-color: #ff99ab;
        box-shadow: 0 2px 4px rgba(255, 182, 193, 0.4);
    }
    #resultMessage {
        min-height: 20px;
        text-align: center;
        font-weight: bold;
        margin: 10px 0;
        padding: 8px;
        border-radius: 6px;
        font-size: 13px;
    }
    .success {
        background-color: #e8f4f1;
        color: #3c766f;
        border: 1px solid #c2e3dd;
    }
    .info {
        background-color: #f0f4fb;
        color: #4a6fa5;
        border: 1px solid #d0ddf0;
    }
    .congratulations {
        text-align: center;
        padding: 20px 12px;
        background-color: #fffdfb;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #f5e1da;
    }
    .congratulations h2 {
        color: #c28e8e;
        margin-bottom: 12px;
        font-size: 18px;
    }
    .congratulations p {
        font-size: 14px;
        margin-bottom: 15px;
        color: #777;
    }
    .btn {
        display: block;
        width: 100%;
        padding: 12px;
        background-color: #a8c8d8;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 15px;
        cursor: pointer;
        transition: background-color 0.3s;
        margin-top: 8px;
        border: 1px solid #8fb8cc;
    }
    .btn:hover {
        background-color: #8fb8cc;
    }
    .btn-success {
        background-color: #c2e3dd;
        border: 1px solid #a8d8ce;
    }
    .btn-success:hover {
        background-color: #a8d8ce;
    }
    /* Anima√ß√£o Brilho */
    @keyframes glow {
        0% { box-shadow: 0 0 5px #c2e3dd, 0 0 10px #c2e3dd; }
        50% { box-shadow: 0 0 15px #c2e3dd, 0 0 25px #c2e3dd; }
        100% { box-shadow: 0 0 5px #c2e3dd, 0 0 10px #c2e3dd; }
    }
    .dict-item.glow {
        animation: glow 0.3s ease-in-out;
    }
    /* Estilos da dica */
    .hint-container {
        margin-top: 10px;
        padding: 8px;
        background-color: #fff9e6;
        border: 1px solid #f5e6c8;
        border-radius: 6px;
        font-size: 12px;
        color: #9a8c5a;
        display: none;
    }
    .hint-container.show {
        display: block;
    }
    #hintBtn {
        background-color: #f5e6c8;
        color: #5a5a5a;
        border: 1px solid #f5e6c8;
    }
    #hintBtn:hover:not(:disabled) {
        background-color: #e6d4b0;
        border-color: #d9c69e;
    }
    #hintBtn:disabled {
        background-color: #c0c0c0;
        border-color: #a0a0a0;
        cursor: not-allowed;
    }
    /* Adapta√ß√£o para telas muito pequenas */
    @media (max-width: 360px) {
        .dictionary-content {
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 6px;
        }
        .dict-item {
            padding: 5px;
            min-height: 50px;
        }
        .dict-char {
            font-size: 15px;
        }
        .dict-pinyin {
            font-size: 10px;
        }
        .dict-meaning {
            font-size: 9px;
        }
    }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Quiz de Tradu√ß√£o</h1>
            <p>Correlacione o texto com sua tradu√ß√£o</p>
        </div>
        <div class="progress">
            Restante: <span id="tasksLeft">0</span>
        </div>
        <!-- Dicion√°rio colaps√°vel -->
        <div class="collapsible-container">
            <div class="collapsible-header" id="collapsibleHeader">
                <span>üìö Dicion√°rio (clique para expandir)</span>
            </div>
            <div class="collapsible-content" id="collapsibleContent">
                <div class="dictionary-content" id="dictionaryContent"></div>
            </div>
        </div>
        <div id="mainContent">
            <div class="task-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div class="task-type" id="taskType">Tradu√ß√£o do chin√™s</div>
                    <button id="sendTaskBtn" title="Enviar tarefa">Enviar em particular ‚úâÔ∏è</button>
                </div>
                <div class="source-text" id="sourceText">Carregando...</div>
                <div class="words-container">
                    <div class="word-list" id="wordsList"></div>
                </div>
                <div class="answer-container">
                    <div class="word-list" id="answerList"></div>
                </div>
                <!-- Container da dica -->
                <div class="hint-container" id="hintContainer">
                    Resposta correta: <span id="hintText"></span>
                </div>
                <!-- Bot√£o da dica -->
                <button id="hintBtn" class="btn">Ver resposta correta (-7 pontos)</button>
                <div id="resultMessage"></div>
            </div>
        </div>
        <div id="congratulations" class="congratulations" style="display: none;">
            <h2>üéâ Parab√©ns!</h2>
            <p>Voc√™ completou todas as tarefas!</p>
            <button class="btn btn-success" id="returnBtn">P√°gina inicial</button>
        </div>
    </div>
    <!-- Conectar dados -->
    <script src="segmentation.js"></script>
    <script src="extra.js"></script>
    <script>
        // Fun√ß√£o de inicializa√ß√£o do Firebase
// ==================== INICIALIZA√á√ÉO DO FIREBASE ====================
// Definir vari√°veis globais para o Firebase
let auth = null;
let db = null;
let currentUser = null;
let docRef = null;
let getDocRef = null;
let updateDocRef = null;
let collectionRef = null;
let queryRef = null;
let whereRef = null;
let getDocsRef = null; // <-- Nova vari√°vel global para getDocs
function getRandomDecoyCount(min = 1, max = 5) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
// Fun√ß√£o de inicializa√ß√£o do Firebase
async function initFirebase() {
    try {
        // Importar dinamicamente os m√≥dulos do Firebase
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js');
        const { getAuth, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js');
        // Importar TODAS as fun√ß√µes necess√°rias do Firestore
        const { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js');
        const firebaseConfig = {
            apiKey: "AIzaSyBvyxPtx5PICYk60HUCERw5Cxh1TyCcZCY",
            authDomain: "antient-9bff0.firebaseapp.com",
            projectId: "antient-9bff0",
            storageBucket: "antient-9bff0.firebasestorage.app",
            messagingSenderId: "311792589414",
            appId: "1:311792589414:web:5fff3154735007c2006ba7",
            measurementId: "G-W4ZQXWRTKK"
        };
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        // Atribuir fun√ß√µes do Firebase √†s vari√°veis globais
        docRef = doc;
        getDocRef = getDoc;
        updateDocRef = updateDoc;
        collectionRef = collection;
        queryRef = query;
        whereRef = where;
        getDocsRef = getDocs; // <-- Muito importante: atribuir getDocs
        // Usar async/await para obter o perfil completo do usu√°rio
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log('üîê Usu√°rio conectado (estado de autentica√ß√£o):', user.uid);
                try {
                    // Solicitar documento do usu√°rio no Firestore
                    const userDocRef = docRef(db, 'users', user.uid);
                    const userDocSnap = await getDocRef(userDocRef); // Usar getDocRef para um documento
                    if (userDocSnap.exists()) {
                        // Agora currentUser tem .friends e outros dados do Firestore
                        currentUser = { uid: user.uid, ...userDocSnap.data() };
                        console.log('‚úÖ Perfil do usu√°rio carregado do Firestore:', currentUser);
                    } else {
                        console.error('‚ùå Perfil n√£o encontrado no Firestore para UID:', user.uid);
                    }
                } catch (profileError) {
                    console.error('‚ùå Erro ao carregar perfil do Firestore para UID:', user.uid, profileError);
                }
            } else {
                console.warn('üîí Usu√°rio n√£o autenticado');
                currentUser = null;
            }
        });
        console.log("Firebase inicializado");
    } catch (e) {
        console.error("‚ùå Erro na inicializa√ß√£o do Firebase:", e);
    }
}
        // ==================== SISTEMA DE PONTOS ====================
        async function updateUserPoints(pointsChange) {
            // Se o Firebase n√£o estiver inicializado ou o usu√°rio n√£o estiver autenticado
            if (!auth || !db || !currentUser || !docRef || !getDocRef || !updateDocRef) {
                const message = pointsChange !== 0 ?
                    `Mudan√ßa de pontos: ${pointsChange} (n√£o salvo - Firebase n√£o est√° pronto)` :
                    '';
                if(message) console.log(message);
                return;
            }
            try {
                const userRef = docRef(db, 'users', currentUser.uid);
                // Obter pontos atuais do usu√°rio
                const userDoc = await getDocRef(userRef);
                let currentPoints = 0;
                if (userDoc.exists()) {
                    currentPoints = userDoc.data().points || 0;
                }
                // Atualizar pontos considerando os atuais
                const newPoints = currentPoints + pointsChange;
                await updateDocRef(userRef, {
                    points: newPoints
                });
                currentUser.points = newPoints;
                console.log(`[Pontos] Mudan√ßa: ${pointsChange}. Agora: ${newPoints}`);
            } catch (e) {
                console.error("‚ùå N√£o foi poss√≠vel salvar pontos no Firestore:", e);
            }
        }
        // ==================== SONS DA INTERFACE ====================
        const uiSounds = {
            click: null,
            hover: null,
            success: null,
            expand: null,
            collapse: null,
            hint: null // Novo som para a dica
        };
        // Fun√ß√£o para pr√©-carregar um som
        function preloadSound(path) {
            return new Promise((resolve, reject) => {
                const audio = new Audio();
                audio.src = path;
                audio.preload = 'auto';
                audio.addEventListener('canplaythrough', () => resolve(audio));
                audio.addEventListener('error', reject);
            });
        }
        // Fun√ß√£o para pr√©-carregar todos os sons da interface
        async function preloadUISounds() {
            try {
                // Caminho relativo de translateall.html para a pasta Wav
                const basePath = '../Wav/';
                // Pr√©-carregar sons
                uiSounds.click = await preloadSound(basePath + 'Click_Standard_00.wav');
                uiSounds.hover = await preloadSound(basePath + 'Click_Soft_00.wav');
                uiSounds.success = await preloadSound(basePath + 'Click_Electronic/Click_Electronic_05.wav');
                uiSounds.expand = await preloadSound(basePath + 'Slide_Electronic_00.wav');
                uiSounds.collapse = await preloadSound(basePath + 'Slide_Electronic_01.wav');
                // Som para a dica
                uiSounds.hint = await preloadSound(basePath + 'Click_Mechanical_00.wav');
                console.log('Todos os sons da interface carregados com sucesso');
            } catch (error) {
                console.warn('N√£o foi poss√≠vel carregar alguns sons da interface:', error);
            }
        }
        // Fun√ß√£o para reproduzir som
        function playSound(sound) {
            if (sound) {
                // Criar clone para permitir m√∫ltiplas reprodu√ß√µes
                const soundClone = sound.cloneNode();
                soundClone.volume = 0.3; // Reduzir volume
                soundClone.play().catch(e => {
                    console.warn('N√£o foi poss√≠vel reproduzir o som:', e);
                });
            }
        }
        // ==================== C√ìDIGO EXISTENTE ====================
        // Cache para arquivos de √°udio
        const audioCache = new Map();
        let hintUsedForCurrentTask = false; // Flag de uso da dica
        // Fun√ß√£o para pr√©-carregar √°udio dos caracteres
        function preloadAudioForCharacters(characters) {
            characters.forEach(hanzi => {
                // Verificar se o caractere existe no charData
                if (!charData || !charData.hasOwnProperty(hanzi)) return;
                const charInfo = charData[hanzi];
                if (!charInfo || !charInfo.pinyin) return;
                const pinyin = charInfo.pinyin;
                let cleanPinyin = pinyin
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/√º/g, 'u')
                    .replace(/v/g, 'u');
                let tone = '1';
                if (pinyin.includes('ƒÅ') || pinyin.includes('≈ç') || pinyin.includes('ƒì') || pinyin.includes('ƒ´') || pinyin.includes('≈´') || pinyin.includes('«ñ')) tone = '1';
                else if (pinyin.includes('√°') || pinyin.includes('√≥') || pinyin.includes('√©') || pinyin.includes('√≠') || pinyin.includes('√∫') || pinyin.includes('«ò')) tone = '2';
                else if (pinyin.includes('«é') || pinyin.includes('«í') || pinyin.includes('ƒõ') || pinyin.includes('«ê') || pinyin.includes('«î') || pinyin.includes('«ö')) tone = '3';
                else if (pinyin.includes('√†') || pinyin.includes('√≤') || pinyin.includes('√®') || pinyin.includes('√¨') || pinyin.includes('√π') || pinyin.includes('«ú')) tone = '4';
                const pinyinKey = cleanPinyin + tone;
                // Corrigir URL - remover espa√ßos extras
                const url = `https://data.dong-chinese.com/pinyin/b/${pinyinKey}.mp3`;
                if (!audioCache.has(hanzi)) {
                    const audio = new Audio();
                    audio.src = url;
                    audio.preload = 'auto';
                    audioCache.set(hanzi, audio);
                    audio.addEventListener('error', (e) => {
                        console.warn(`N√£o foi poss√≠vel pr√©-carregar √°udio para ${hanzi}`);
                    });
                }
            });
        }
        // Fun√ß√£o para pronunciar caracteres com feedback visual
        function playHanziSound(hanzi, element) {
            // Verificar se o caractere existe no charData
            if (!charData || !charData.hasOwnProperty(hanzi)) return;
            // Feedback visual - real√ßar com perolado
            if (element) {
                const originalBg = element.style.backgroundColor || (element.classList.contains('selected') ? '#2ecc71' : '#fff');
                element.style.backgroundColor = '#e0f7fa';
                setTimeout(() => {
                    element.style.backgroundColor = originalBg;
                }, 300);
            }
            if (audioCache.has(hanzi)) {
                const audio = audioCache.get(hanzi);
                const audioClone = audio.cloneNode();
                audioClone.play().catch(e => {
                    console.warn(`N√£o foi poss√≠vel reproduzir √°udio em cache para ${hanzi}`);
                });
            } else {
                const charInfo = charData[hanzi];
                if (!charInfo || !charInfo.pinyin) return;
                const pinyin = charInfo.pinyin;
                let cleanPinyin = pinyin
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/√º/g, 'u')
                    .replace(/v/g, 'u');
                let tone = '1';
                if (pinyin.includes('ƒÅ') || pinyin.includes('≈ç') || pinyin.includes('ƒì') || pinyin.includes('ƒ´') || pinyin.includes('≈´') || pinyin.includes('«ñ')) tone = '1';
                else if (pinyin.includes('√°') || pinyin.includes('√≥') || pinyin.includes('√©') || pinyin.includes('√≠') || pinyin.includes('√∫') || pinyin.includes('«ò')) tone = '2';
                else if (pinyin.includes('«é') || pinyin.includes('«í') || pinyin.includes('ƒõ') || pinyin.includes('«ê') || pinyin.includes('«î') || pinyin.includes('«ö')) tone = '3';
                else if (pinyin.includes('√†') || pinyin.includes('√≤') || pinyin.includes('√®') || pinyin.includes('√¨') || pinyin.includes('√π') || pinyin.includes('«ú')) tone = '4';
                const pinyinKey = cleanPinyin + tone;
                // Corrigir URL - remover espa√ßos extras
                const url = `https://data.dong-chinese.com/pinyin/b/${pinyinKey}.mp3`;
                const audio = new Audio(url);
                audio.play().catch(e => {
                    console.warn(`N√£o foi poss√≠vel reproduzir som para ${hanzi}: ${url}`);
                });
            }
        }
        // Fun√ß√£o para pronunciar caractere do dicion√°rio com efeito de brilho
        function playDictionaryHanziSound(hanzi, element) {
            // Adicionar classe de brilho
            element.classList.add('glow');
            // Remover classe ap√≥s 300ms
            setTimeout(() => {
                element.classList.remove('glow');
            }, 300);
            // Reproduzir som
            playHanziSound(hanzi, element);
        }
        // Fun√ß√£o para exibir dicion√°rio
        function renderDictionary() {
            const dictionaryContent = document.getElementById('dictionaryContent');
            dictionaryContent.innerHTML = '';
            // Extrair texto de todos os locais necess√°rios
            const sourceText = document.getElementById('sourceText').textContent;
            const wordsList = document.getElementById('wordsList').textContent;
            const answerList = document.getElementById('answerList').textContent;
            const allText = sourceText + wordsList + answerList;
            const chars = [...allText]; // dividir em caracteres
            // Obter caracteres √∫nicos que existem no charData
            const uniqueChars = [...new Set(chars)]
                .filter(char => charData && charData.hasOwnProperty(char));
            uniqueChars.forEach(char => {
                const charInfo = charData[char];
                const dictItem = document.createElement('div');
                dictItem.className = 'dict-item';
                dictItem.dataset.hanzi = char;
                dictItem.innerHTML = `
                    <div class="dict-char">${char}</div>
                    <div class="dict-pinyin">${charInfo.pinyin}</div>
                    <div class="dict-meaning">${charInfo.meaning}</div>
                `;
                // Adicionar som ao clicar no item do dicion√°rio
                dictItem.addEventListener('click', function() {
                    playSound(uiSounds.click); // Reproduzir som da interface
                    playDictionaryHanziSound(char, this);
                });
                dictionaryContent.appendChild(dictItem);
            });
        }
        document.addEventListener('DOMContentLoaded', async function() { // async
            // ==================== INICIALIZA√á√ÉO ====================
            await initFirebase(); // Aguardar inicializa√ß√£o do Firebase
            await preloadUISounds(); // Aguardar carregamento dos sons
            // ==================== FUN√á√ïES ====================
            // Fun√ß√£o para formar string de compartilhamento de tarefa com aspas corretas
            function getTaskShareString(task, currentAnswerWords) {
                const tokens = task.words.map(w => `"${w}"`).join(', ');
                if (task.type === 'toTranslation') {
                    return `‚Äô‚Äò‚Äô‚Äò [original]->[translation]: {"${task.source}"}->{"${task.correctAnswer}"}; [tokens]: {${tokens}} ‚Äô‚Äò‚Äô‚Äò`;
                } else {
                    return `‚Äô‚Äò‚Äô‚Äò [translation]->[original]: {"${task.source}"}->{"${task.correctAnswer}"}; [tokens]: {${tokens}} ‚Äô‚Äò‚Äô‚Äò`;
                }
            }
            // ==================== EVENTOS DA INTERFACE ====================
            // Dicion√°rio colaps√°vel
            const collapsibleHeader = document.getElementById('collapsibleHeader');
            const collapsibleContent = document.getElementById('collapsibleContent');
            const sendTaskBtn = document.getElementById('sendTaskBtn');
            // === ELEMENTOS DOM PARA JANELAS MODAIS ===
            const modalSelectRecipient = document.getElementById('modalSelectRecipient');
            const closeRecipientModalBtn = document.getElementById('closeRecipientModalBtn');
            const recipientList = document.getElementById('recipientList');
            const noFriendsMessage = document.getElementById('noFriendsMessage');
            const modalShareTask = document.getElementById('modalShareTaskChat'); // Usar ID √∫nico
            const closeModalBtn = document.getElementById('closeModalBtnChat'); // Usar ID √∫nico
            const shareTaskFrame = document.getElementById('shareTaskFrame');
            const loadingIframe = document.getElementById('loadingIframe');
            // === GERENCIADOR DO BOT√ÉO ‚úâÔ∏è ===
            sendTaskBtn.addEventListener('click', async function() {
                playSound(uiSounds.click);
                if (!currentUser || !currentUser.uid) {
                    alert('‚õî Fa√ßa login primeiro.');
                    return;
                }
                // Verificar se a lista de amigos foi carregada
                if (!Array.isArray(currentUser.friends)) {
                    alert('Dados de amigos ainda est√£o sendo carregados ou ausentes... Tente novamente mais tarde.');
                    console.warn("currentUser.friends n√£o √© uma matriz ou est√° ausente:", currentUser.friends);
                    return;
                }
                modalSelectRecipient.style.display = 'flex';
                loadFriendsForSelection();
            });
            // === CARREGAR AMIGOS ===
// === CARREGAR AMIGOS ===
async function loadFriendsForSelection() {
    const recipientList = document.getElementById('recipientList');
    const noFriendsMessage = document.getElementById('noFriendsMessage');
    recipientList.innerHTML = '<div style="text-align:center;padding:10px;">Carregando amigos...</div>';
    noFriendsMessage.style.display = 'none';
    // Nova verifica√ß√£o mais rigorosa dentro da fun√ß√£o
    if (!currentUser || !Array.isArray(currentUser.friends) || currentUser.friends.length === 0) {
        console.warn("Nenhum amigo para carregar ou currentUser.friends n√£o √© uma matriz:", currentUser?.friends);
        recipientList.innerHTML = '';
        noFriendsMessage.style.display = 'block';
        return;
    }
    try {
        // Criar refer√™ncia √† cole√ß√£o de usu√°rios
        const friendsRef = collectionRef(db, 'users');
        // Criar consulta com filtro pelos IDs dos amigos
        // Limitar a 10, pois consultas 'in' do Firestore s√£o limitadas a 10 elementos
        const friendsToQuery = currentUser.friends.slice(0, 10);
        const q = queryRef(friendsRef, whereRef('__name__', 'in', friendsToQuery));
        // Usar getDocsRef para executar a consulta, retornando v√°rios documentos
        const querySnap = await getDocsRef(q); // <-- Corrigido: era getDocRef(q)
        const friends = [];
        querySnap.forEach(doc => {
            friends.push({ id: doc.id, ...doc.data() });
        });
        recipientList.innerHTML = '';
        if (friends.length === 0) {
            recipientList.innerHTML = '<div style="text-align:center;color:#777">Amigos n√£o encontrados</div>';
            return;
        }
        // Apenas lista de nomes e pontos
        friends.forEach(friend => {
            const card = document.createElement('div');
            card.className = 'friend-card';
            // Apenas texto
            card.textContent = `${friend.displayName} (${friend.points || 0} pontos)`;
            // Estilos j√° definidos no CSS, adicionar gerenciador de clique
            card.addEventListener('click', () => selectRecipient(friend));
            recipientList.appendChild(card);
        });
    } catch (error) {
        console.error("Erro ao carregar amigos:", error);
        recipientList.innerHTML = '<div style="text-align:center;color:red">Erro ao carregar</div>';
    }
}
            // === SELECIONAR DESTINAT√ÅRIO ===
            function selectRecipient(friend) {
                modalSelectRecipient.style.display = 'none';
                const task = tasks[currentTaskIndex];
                const shareString = getTaskShareString(task, currentAnswer);
                const encodedShareString = encodeURIComponent(shareString);
                const chatUrl = `../chat.html#chat/${friend.id}/${encodedShareString}`;
                // Mostrar janela modal do chat
                modalShareTask.style.display = 'flex';
                shareTaskFrame.src = '';
                loadingIframe.style.display = 'block';
                shareTaskFrame.style.display = 'none';
                setTimeout(() => {
                    shareTaskFrame.src = chatUrl;
                }, 10);
                shareTaskFrame.onload = () => {
                    loadingIframe.style.display = 'none';
                    shareTaskFrame.style.display = 'block';
                };
            }
            // === FECHAR MODAIS ===
            closeRecipientModalBtn?.addEventListener('click', () => {
                modalSelectRecipient.style.display = 'none';
            });
            closeModalBtn?.addEventListener('click', () => {
                modalShareTask.style.display = 'none';
                shareTaskFrame.src = '';
            });
            // Fechar com Esc
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (modalSelectRecipient.style.display !== 'none') {
                        modalSelectRecipient.style.display = 'none';
                    }
                    if (modalShareTask.style.display !== 'none') {
                        modalShareTask.style.display = 'none';
                        shareTaskFrame.src = '';
                    }
                }
            });
            // Fechar ao clicar fora
            modalSelectRecipient?.addEventListener('click', (e) => {
                if (e.target === modalSelectRecipient) modalSelectRecipient.style.display = 'none';
            });
            modalShareTask?.addEventListener('click', (e) => {
                if (e.target === modalShareTask) modalShareTask.style.display = 'none';
            });
            collapsibleHeader.addEventListener('click', function() {
                this.classList.toggle('active');
                collapsibleContent.classList.toggle('show');
                // Reproduzir som dependendo do estado
                if (collapsibleContent.classList.contains('show')) {
                    playSound(uiSounds.expand);
                } else {
                    playSound(uiSounds.collapse);
                }
            });
            // Bot√£o "P√°gina inicial"
            const returnBtn = document.getElementById('returnBtn');
            returnBtn.addEventListener('click', function() {
                playSound(uiSounds.click);
                window.location.href = '../index.html';
            });
            // Efeitos hover para bot√µes (exceto hintBtn)
            document.querySelectorAll('.btn:not(#hintBtn), .word, .dict-item').forEach(el => {
                el.addEventListener('mouseenter', () => playSound(uiSounds.hover));
            });
            // ==================== L√ìGICA DA DICA ====================
            const hintBtn = document.getElementById('hintBtn');
            const hintContainer = document.getElementById('hintContainer');
            const hintText = document.getElementById('hintText');
            hintBtn.addEventListener('click', async function() {
                if (hintUsedForCurrentTask) return; // Prote√ß√£o contra uso repetido
                playSound(uiSounds.hint); // Reproduzir som da dica
                hintUsedForCurrentTask = true;
                this.disabled = true;
                // Subtrair pontos
                await updateUserPoints(-7);
                // Mostrar dica
                const currentTask = tasks[currentTaskIndex];
                if (currentTask.type === 'toTranslation') {
                    hintText.textContent = currentTask.correctAnswer;
                } else {
                    // Para tradu√ß√£o de russo para chin√™s, mostrar caracteres separadamente
                    hintText.textContent = currentTask.correctAnswer.split('').join(' ');
                }
                hintContainer.classList.add('show');
            });
            // ==================== L√ìGICA PRINCIPAL ====================
            // Preparar dados
            // Verificar SentenceData agora dentro de DOMContentLoaded, onde √© garantida
            // Verificar dados principais
            if (typeof SentenceData === 'undefined' || !SentenceData.sentences || !Array.isArray(SentenceData.sentences)) {
                console.error("SentenceData n√£o carregada ou formato incorreto!");
                document.getElementById('sourceText').textContent = "Erro: dados da li√ß√£o n√£o carregados.";
                return;
            }
            // Verificar dados adicionais (opcionais, mas se existirem devem ser v√°lidos)
            let extraSentences = [];
            if (typeof extra !== 'undefined' && extra.sentences && Array.isArray(extra.sentences)) {
                console.log(`‚úÖ Carregado ${extra.sentences.length} frases adicionais de extra.js`);
                extraSentences = extra.sentences;
            } else {
                console.warn("‚ö†Ô∏è Arquivo extra.js n√£o carregado ou formato incorreto. Continuando sem tarefas adicionais.");
            }
            // Combinar frases da fonte principal e adicional
            const allSentences = [...SentenceData.sentences, ...extraSentences];
            const allOriginals = allSentences.map(s => s.original);
            const allTranslations = allSentences.map(s => s.translation);
            function cleanRussian(text) {
                return text.replace(/[^\p{L}\p{N}\s]/gu, '').toLowerCase().trim();
            }
            const allRussianWords = [];
            allTranslations.forEach(trans => {
                const cleaned = cleanRussian(trans);
                allRussianWords.push(...cleaned.split(' ').filter(word => word));
            });
            const allChineseChars = [];
            allOriginals.forEach(orig => {
                allChineseChars.push(...orig.split(''));
            });
            function shuffleArray(array) {
                const arr = [...array];
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            }
            let tasks = [];
            allSentences.forEach(sentence => {
                const actualRussianWords = cleanRussian(sentence.translation).split(' ').filter(w => w);
                const actualChineseChars = sentence.original.split('');
                // --- Para tradu√ß√£o de chin√™s para russo ---
                // Filtrar pool geral de palavras: apenas aquelas que N√ÉO est√£o na resposta real
                const availableRussianDecoys = allRussianWords.filter(word => !actualRussianWords.includes(word));
                // Remover duplicatas do pool de iscas
                const uniqueRussianDecoys = [...new Set(availableRussianDecoys)];
                // Embaralhar
                const shuffledRussianDecoys = shuffleArray(uniqueRussianDecoys);
                // Pegar quantidade aleat√≥ria de 1 a 5, mas n√£o mais do que dispon√≠vel
                const russianDecoyCount = Math.min(getRandomDecoyCount(), shuffledRussianDecoys.length);
                const russianDecoys = shuffledRussianDecoys.slice(0, russianDecoyCount);
                tasks.push({
                    type: 'toTranslation',
                    source: sentence.original,
                    correctAnswer: cleanRussian(sentence.translation),
                    words: shuffleArray([...actualRussianWords, ...russianDecoys]),
                    direction: 'do chin√™s para o russo'
                });
                // --- Para tradu√ß√£o de russo para chin√™s ---
                const availableChineseDecoys = allChineseChars.filter(char => !actualChineseChars.includes(char));
                const uniqueChineseDecoys = [...new Set(availableChineseDecoys)];
                const shuffledChineseDecoys = shuffleArray(uniqueChineseDecoys);
                const chineseDecoyCount = Math.min(getRandomDecoyCount(), shuffledChineseDecoys.length);
                const chineseDecoys = shuffledChineseDecoys.slice(0, chineseDecoyCount);
                tasks.push({
                    type: 'toOriginal',
                    source: sentence.translation,
                    correctAnswer: sentence.original,
                    words: shuffleArray([...actualChineseChars, ...chineseDecoys]),
                    direction: 'do russo para o chin√™s'
                });
            });
            tasks = shuffleArray(tasks);
            let currentTaskIndex = 0;
            let currentAnswer = [];
            const sourceText = document.getElementById('sourceText');
            const wordsList = document.getElementById('wordsList');
            const answerList = document.getElementById('answerList');
            const resultMessage = document.getElementById('resultMessage');
            const tasksLeft = document.getElementById('tasksLeft');
            const taskType = document.getElementById('taskType');
            const mainContent = document.getElementById('mainContent');
            const congratulations = document.getElementById('congratulations');
            const returnBtnCongrats = document.getElementById('returnBtn'); // Reutilizar
            function renderTask() {
                if (currentTaskIndex >= tasks.length) {
                    showCompletionScreen();
                    return;
                }
                // Resetar estado da dica para nova tarefa
                hintUsedForCurrentTask = false;
                hintBtn.disabled = false;
                hintContainer.classList.remove('show');
                const task = tasks[currentTaskIndex];
                taskType.textContent = `Tradu√ß√£o ${task.direction}`;
                sourceText.textContent = task.source;
                tasksLeft.textContent = tasks.length - currentTaskIndex;
                currentAnswer = [];
                answerList.innerHTML = '';
                wordsList.innerHTML = '';
                if (task.type === 'toOriginal') {
                    // Pr√©-carregar √°udio para caracteres chineses
                    const chineseCharacters = task.words.filter(word => charData && charData.hasOwnProperty(word));
                    preloadAudioForCharacters(chineseCharacters);
                }
                task.words.forEach(word => {
                    const el = document.createElement('div');
                    el.className = 'word';
                    el.textContent = word;
                    el.dataset.word = word;
                    wordsList.appendChild(el);
                });
                document.querySelectorAll('#wordsList .word').forEach(el => {
                    el.addEventListener('click', async function() { // async
                        playSound(uiSounds.click); // Reproduzir som da interface
                        const word = this.dataset.word;
                        // Pronunciar com feedback visual
                        playHanziSound(word, this);
                        this.remove();
                        const answerEl = document.createElement('div');
                        answerEl.className = 'word selected';
                        answerEl.textContent = word;
                        answerEl.dataset.word = word;
                        answerList.appendChild(answerEl);
                        currentAnswer.push(word);
                        await checkAnswer(); // Verificar imediatamente ap√≥s adicionar
                    });
                });
                // Exibir dicion√°rio ap√≥s renderizar tarefa
                setTimeout(renderDictionary, 100);
                resultMessage.className = 'info';
                resultMessage.textContent = 'Monte a tradu√ß√£o. Clique no caractere para ouvi-lo.';
            }
            // ========== L√ìGICA DE VERIFICA√á√ÉO ALTERADA ==========
            async function checkAnswer() {
                const task = tasks[currentTaskIndex];
                const currentText = currentAnswer.join(' ').trim();
                if (task.type === 'toTranslation') {
                    if (currentText === task.correctAnswer) {
                        playSound(uiSounds.success); // Reproduzir som de sucesso
                        await updateUserPoints(5); // Adicionar 5 pontos
                        showSuccess();
                    }
                } else {
                    const currentTextOriginal = currentAnswer.join(''); // Para chin√™s, juntar sem espa√ßos
                    if (currentTextOriginal === task.correctAnswer) {
                        playSound(uiSounds.success); // Reproduzir som de sucesso
                        await updateUserPoints(5); // Adicionar 5 pontos
                        showSuccess();
                    }
                }
            }
            function showSuccess() {
                resultMessage.className = 'success';
                resultMessage.textContent = '‚úÖ Correto! +5 pontos. Pr√≥xima tarefa...';
                setTimeout(() => {
                    currentTaskIndex++;
                    renderTask();
                }, 1200);
            }
            answerList.addEventListener('click', async function(e) { // async
                if (e.target.classList.contains('word')) {
                    playSound(uiSounds.click); // Reproduzir som da interface
                    const word = e.target.dataset.word;
                    // Pronunciar com feedback visual
                    playHanziSound(word, e.target);
                    e.target.remove();
                    const wordEl = document.createElement('div');
                    wordEl.className = 'word';
                    wordEl.textContent = word;
                    wordEl.dataset.word = word;
                    wordsList.appendChild(wordEl);
                    const index = currentAnswer.indexOf(word);
                    if (index !== -1) currentAnswer.splice(index, 1);
                    wordEl.addEventListener('click', async function() { // async
                        playSound(uiSounds.click); // Reproduzir som da interface
                        const w = this.dataset.word;
                        // Pronunciar com feedback visual
                        playHanziSound(w, this);
                        this.remove();
                        const aEl = document.createElement('div');
                        aEl.className = 'word selected';
                        aEl.textContent = w;
                        aEl.dataset.word = w;
                        answerList.appendChild(aEl);
                        currentAnswer.push(w);
                        await checkAnswer(); // Verificar ap√≥s adicionar
                    });
                }
            });
            function showCompletionScreen() {
                mainContent.style.display = 'none';
                congratulations.style.display = 'block';
            }
            // Inicializar primeira tarefa
            renderTask();
        });
    </script>
    <script src="../uploader.js"></script>
    <!-- Janela modal de sele√ß√£o de destinat√°rio -->
    <div id="modalSelectRecipient" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì¨ Escolha o destinat√°rio</h3>
                <button id="closeRecipientModalBtn" class="modal-close">√ó</button>
            </div>
            <div id="recipientList" class="friends-grid">
                <!-- Lista de amigos ser√° carregada aqui -->
            </div>
            <div id="noFriendsMessage" class="info-message">
                Voc√™ ainda n√£o tem amigos. Adicione-os na se√ß√£o "Comunidade".
            </div>
        </div>
    </div>
    <!-- Janela modal de chat (corrigido ID) -->
    <div id="modalShareTaskChat" class="modal-overlay">
        <div class="modal-content chat-modal">
            <div class="modal-header">
                <h3>üí¨ Enviando tarefa</h3>
                <button id="closeModalBtnChat" class="modal-close">√ó</button>
            </div>
            <div id="loadingIframe">Carregando chat...</div>
            <iframe id="shareTaskFrame" src="" class="chat-iframe" frameborder="0"></iframe>
        </div>
    </div>
</body>
</html>
